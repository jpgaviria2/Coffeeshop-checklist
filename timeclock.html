<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time Clock - Trails Coffee</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 10px;
        }
        .container {
            max-width: 800px; margin: 0 auto; background: white;
            border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; text-align: center;
        }
        .header h1 { font-size: 1.5em; margin-bottom: 5px; }
        .nav-bar {
            display: flex; background: #f8f9fa; border-bottom: 2px solid #e0e0e0;
        }
        .nav-bar a {
            flex: 1; padding: 15px; text-align: center; text-decoration: none;
            color: #666; font-weight: 600; font-size: 0.85em;
        }
        .nav-bar a.active {
            color: #667eea; border-bottom: 3px solid #667eea; background: white;
        }
        .content { padding: 20px; }
        #accessDenied { display: none; text-align: center; padding: 40px; color: #999; }
        #timeClockContent { display: none; }
        
        .date-nav {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 10px;
        }
        .date-nav button {
            background: #667eea; color: white; border: none; padding: 8px 16px;
            border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        .date-nav .date-label { font-weight: 600; font-size: 1.1em; }

        .staff-card {
            background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }
        .staff-card .name { font-weight: 700; font-size: 1.1em; color: #333; }
        .staff-card .shifts { margin-top: 8px; }
        .shift-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 6px 0; border-bottom: 1px solid #eee;
        }
        .shift-row:last-child { border-bottom: none; }
        .shift-time { color: #28a745; font-weight: 600; }
        .shift-hours {
            background: #667eea; color: white; padding: 3px 10px;
            border-radius: 20px; font-size: 0.85em; font-weight: 600;
        }
        .shift-missing {
            background: #ffc107; color: #333; padding: 3px 10px;
            border-radius: 20px; font-size: 0.85em; font-weight: 600;
        }
        .total-hours {
            text-align: right; margin-top: 8px; padding-top: 8px;
            border-top: 2px solid #ddd; font-weight: 700; color: #667eea;
        }
        
        .weekly-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border-radius: 12px; padding: 15px; margin-bottom: 20px;
        }
        .weekly-summary h3 { margin-bottom: 10px; }
        .weekly-row {
            display: flex; justify-content: space-between; padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .weekly-row:last-child { border-bottom: none; }
        
        .no-data { text-align: center; padding: 30px; color: #999; }
        #loading { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚è±Ô∏è Time Clock</h1>
            <p>Staff Hours Tracker</p>
        </div>

        <div class="nav-bar">
            <a href="index.html">üìã Checklists</a>
            <a href="status.html">üìä Status</a>
            <a href="procedures.html">üìñ Procedures</a>
            <a href="timeclock.html" class="active">‚è±Ô∏è Time Clock</a>
        </div>

        <div class="content">
            <div id="accessDenied">
                <h2>üîí Admin Access Only</h2>
                <p style="margin-top:10px;">This page is only available to managers.</p>
                <p style="margin-top:10px;font-size:0.9em;">Please log in on the <a href="index.html">Checklists page</a> first.</p>
            </div>

            <div id="loading">‚è≥ Loading time clock data...</div>

            <div id="timeClockContent">
                <!-- Weekly Summary -->
                <div class="weekly-summary" id="weeklySummary"></div>

                <!-- Date Navigation -->
                <div class="date-nav">
                    <button onclick="changeDay(-1)">‚Üê Prev</button>
                    <span class="date-label" id="currentDateLabel">Today</span>
                    <button onclick="changeDay(1)">Next ‚Üí</button>
                </div>

                <!-- Staff Cards -->
                <div id="staffCards"></div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/nostr-tools@2.7.2/lib/nostr.bundle.js"></script>
    <script src="event-cache.js"></script>
    <script src="timeclock.js"></script>
    <script>
        let currentDate = new Date();
        currentDate.setHours(0, 0, 0, 0);
        let allTimeEvents = [];

        const ADMIN_PUBKEYS = timeClock.ADMIN_PUBKEYS;
        const STAFF_NAMES = timeClock.STAFF_NAMES;

        window.addEventListener('DOMContentLoaded', async () => {
            // Check admin access
            const nsec = localStorage.getItem('trails-nsec');
            if (!nsec) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('accessDenied').style.display = 'block';
                return;
            }

            try {
                const sk = NostrTools.nip19.decode(nsec).data;
                const pk = NostrTools.getPublicKey(sk);
                
                if (!timeClock.isAdmin(pk)) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('accessDenied').style.display = 'block';
                    return;
                }
            } catch (e) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('accessDenied').style.display = 'block';
                return;
            }

            // Load time events from cache first, then refresh
            await loadTimeEvents();
        });

        async function loadTimeEvents() {
            // Get all cached events
            const cached = await EVENT_CACHE.getAllEvents();
            allTimeEvents = cached.filter(e => {
                try {
                    const c = JSON.parse(e.content);
                    return c.timeclock === 'checkin' || c.timeclock === 'checkout';
                } catch { return false; }
            });

            console.log(`‚è±Ô∏è Found ${allTimeEvents.length} time clock events`);

            // Wait for background fetch to complete
            await RELAY_FETCHER.fetchFromRelays();

            // Reload from cache
            const refreshed = await EVENT_CACHE.getAllEvents();
            allTimeEvents = refreshed.filter(e => {
                try {
                    const c = JSON.parse(e.content);
                    return c.timeclock === 'checkin' || c.timeclock === 'checkout';
                } catch { return false; }
            });

            document.getElementById('loading').style.display = 'none';
            document.getElementById('timeClockContent').style.display = 'block';

            renderDay();
            renderWeeklySummary();
        }

        function changeDay(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            renderDay();
        }

        function renderDay() {
            const dateStr = currentDate.toISOString().split('T')[0];
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const label = document.getElementById('currentDateLabel');
            if (currentDate.getTime() === today.getTime()) {
                label.textContent = 'Today ‚Äî ' + formatDateShort(currentDate);
            } else {
                label.textContent = formatDateShort(currentDate);
            }

            // Filter events for this date
            const dayStart = Math.floor(currentDate.getTime() / 1000);
            const dayEnd = dayStart + 86400;
            
            const dayEvents = allTimeEvents.filter(e => e.created_at >= dayStart && e.created_at < dayEnd);
            
            // Group by staff
            const staffData = {};
            dayEvents.forEach(e => {
                const content = JSON.parse(e.content);
                const name = STAFF_NAMES[e.pubkey] || e.pubkey.substring(0, 8);
                if (!staffData[e.pubkey]) staffData[e.pubkey] = { name, events: [] };
                staffData[e.pubkey].events.push({
                    type: content.timeclock,
                    time: new Date(e.created_at * 1000),
                    content
                });
            });

            // Sort each staff's events by time
            Object.values(staffData).forEach(s => s.events.sort((a, b) => a.time - b.time));

            const container = document.getElementById('staffCards');
            container.innerHTML = '';

            if (Object.keys(staffData).length === 0) {
                container.innerHTML = '<div class="no-data">No check-ins for this date</div>';
                return;
            }

            Object.entries(staffData).forEach(([pubkey, data]) => {
                const card = document.createElement('div');
                card.className = 'staff-card';

                const nameDiv = document.createElement('div');
                nameDiv.className = 'name';
                nameDiv.textContent = data.name;
                card.appendChild(nameDiv);

                const shiftsDiv = document.createElement('div');
                shiftsDiv.className = 'shifts';

                // Pair check-ins with check-outs
                let totalMinutes = 0;
                let i = 0;
                const events = data.events;

                while (i < events.length) {
                    const row = document.createElement('div');
                    row.className = 'shift-row';

                    if (events[i].type === 'checkin') {
                        const checkIn = events[i];
                        const checkOut = (i + 1 < events.length && events[i + 1].type === 'checkout') ? events[i + 1] : null;

                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'shift-time';
                        timeSpan.textContent = timeClock.formatTimeShort(checkIn.time) + ' ‚Üí ' + 
                            (checkOut ? timeClock.formatTimeShort(checkOut.time) : '‚ö†Ô∏è No checkout');

                        row.appendChild(timeSpan);

                        if (checkOut) {
                            const mins = (checkOut.time - checkIn.time) / 60000;
                            totalMinutes += mins;
                            const hoursSpan = document.createElement('span');
                            hoursSpan.className = 'shift-hours';
                            hoursSpan.textContent = (mins / 60).toFixed(1) + 'h';
                            row.appendChild(hoursSpan);
                            i += 2;
                        } else {
                            const missingSpan = document.createElement('span');
                            missingSpan.className = 'shift-missing';
                            missingSpan.textContent = 'Missing checkout';
                            row.appendChild(missingSpan);
                            i += 1;
                        }
                    } else {
                        // Orphan checkout
                        const timeSpan = document.createElement('span');
                        timeSpan.className = 'shift-time';
                        timeSpan.textContent = '‚ö†Ô∏è Checkout without check-in: ' + timeClock.formatTimeShort(events[i].time);
                        row.appendChild(timeSpan);
                        i += 1;
                    }

                    shiftsDiv.appendChild(row);
                }

                card.appendChild(shiftsDiv);

                if (totalMinutes > 0) {
                    const totalDiv = document.createElement('div');
                    totalDiv.className = 'total-hours';
                    totalDiv.textContent = 'Total: ' + (totalMinutes / 60).toFixed(1) + ' hours';
                    card.appendChild(totalDiv);
                }

                container.appendChild(card);
            });
        }

        function renderWeeklySummary() {
            // Get current week (Mon-Sun)
            const today = new Date();
            const dayOfWeek = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            monday.setHours(0, 0, 0, 0);

            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 7);

            const weekStart = Math.floor(monday.getTime() / 1000);
            const weekEnd = Math.floor(sunday.getTime() / 1000);

            const weekEvents = allTimeEvents.filter(e => e.created_at >= weekStart && e.created_at < weekEnd);

            // Calculate hours per staff
            const staffHours = {};
            const byStaff = {};
            weekEvents.forEach(e => {
                if (!byStaff[e.pubkey]) byStaff[e.pubkey] = [];
                byStaff[e.pubkey].push({
                    type: JSON.parse(e.content).timeclock,
                    time: new Date(e.created_at * 1000)
                });
            });

            Object.entries(byStaff).forEach(([pk, events]) => {
                events.sort((a, b) => a.time - b.time);
                let total = 0;
                for (let i = 0; i < events.length - 1; i++) {
                    if (events[i].type === 'checkin' && events[i + 1].type === 'checkout') {
                        total += (events[i + 1].time - events[i].time) / 3600000;
                        i++;
                    }
                }
                const name = STAFF_NAMES[pk] || pk.substring(0, 8);
                staffHours[name] = (staffHours[name] || 0) + total;
            });

            const container = document.getElementById('weeklySummary');
            if (Object.keys(staffHours).length === 0) {
                container.innerHTML = '<h3>üìä This Week</h3><p style="opacity:0.8;margin-top:8px;">No time clock data yet</p>';
                return;
            }

            let html = `<h3>üìä Week of ${formatDateShort(monday)}</h3>`;
            Object.entries(staffHours).sort((a, b) => b[1] - a[1]).forEach(([name, hours]) => {
                html += `<div class="weekly-row"><span>${name}</span><span>${hours.toFixed(1)}h</span></div>`;
            });
            container.innerHTML = html;
        }

        function formatDateShort(date) {
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}`;
        }
    </script>
</body>
</html>
